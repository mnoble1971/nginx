# /etc/nginx/conf.d/portal.conf
# Browser UI = Basic Auth (https://IP/)
# API access = Bearer token (https://IP/api/...)
# API mirrors the same folders under /api/<folder>/

map $http_authorization $api_token_valid {
    default 0;
    "Bearer insert_token" 1;
}

# -----------------------
# HTTP -> HTTPS redirect
# -----------------------
server {
    listen 80 default_server;
    server_name _;
    return 301 https://$host$request_uri;
}

# -----------------------
# HTTPS (443) - Portal + API
# -----------------------
server {
    listen 443 ssl default_server;
    server_name _;

    # Self-signed certs (create these as shown earlier)
    ssl_certificate     /etc/nginx/certs/nginx.crt;
    ssl_certificate_key /etc/nginx/certs/nginx.key;

    ssl_protocols TLSv1.2 TLSv1.3;

    # -----------------------
    # UI (Basic Auth)
    # -----------------------
    location / {
        root /var/www/html;
        index index.html;
        autoindex off;

        auth_basic "Operations Portal";
        auth_basic_user_file /etc/nginx/.htpasswd;

        limit_except GET HEAD { deny all; }
    }

    location /logs/ {
        alias /var/www/logs/;
        autoindex on;

        auth_basic "Operations Portal";
        auth_basic_user_file /etc/nginx/.htpasswd;

        limit_except GET HEAD { deny all; }
    }

    location /dynatrace/ {
        alias /var/www/dynatrace/;
        autoindex on;

        auth_basic "Operations Portal";
        auth_basic_user_file /etc/nginx/.htpasswd;

        limit_except GET HEAD { deny all; }
    }

    location /misc/ {
        alias /var/www/misc/;
        autoindex on;

        auth_basic "Operations Portal";
        auth_basic_user_file /etc/nginx/.htpasswd;

        limit_except GET HEAD { deny all; }
    }

    # -----------------------
    # API (Bearer token)
    # Mirrors the same folders under /api/...
    # -----------------------

    # Bearer challenge only for API paths
    location @api_unauthorized {
        add_header WWW-Authenticate 'Bearer realm="API"' always;
        return 401;
    }

    # API mirror: /api/logs/ -> /var/www/logs/
    location /api/logs/ {
        error_page 401 = @api_unauthorized;

        alias /var/www/logs/;
        autoindex on;

        if ($api_token_valid = 0) { return 401; }
        limit_except GET HEAD { deny all; }
    }

    # API mirror: /api/dynatrace/ -> /var/www/dynatrace/
    location /api/dynatrace/ {
        error_page 401 = @api_unauthorized;

        alias /var/www/dynatrace/;
        autoindex on;

        if ($api_token_valid = 0) { return 401; }
        limit_except GET HEAD { deny all; }
    }

    # API mirror: /api/misc/ -> /var/www/misc/
    location /api/misc/ {
        error_page 401 = @api_unauthorized;

        alias /var/www/misc/;
        autoindex on;

        if ($api_token_valid = 0) { return 401; }
        limit_except GET HEAD { deny all; }
    }

    # API base: /api/ -> /var/www/api/ (optional static API content)
    location /api/ {
        error_page 401 = @api_unauthorized;

        alias /var/www/api/;
        autoindex on;

        if ($api_token_valid = 0) { return 401; }
        limit_except GET HEAD POST PUT DELETE { deny all; }
    }
}